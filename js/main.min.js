

//播放控制
var myAudio = $("audio")[0];
var bgPic;
var lyricArr = [];
// 播放/暂停控制
$(".btn-play").click(function(){
	if (myAudio.paused) {
		play()
	} else {
		pause()
	}
});
// 频道切换
$(".icon-diantai").click(function(){
	jsonpGetChannel();
});
// 播放下一曲音乐
$(".btn-next").click(function(){
	getmusic();	
});
function play(){
	myAudio.play();
    $('.btn-play').removeClass('icon-play').addClass('icon-pause1');
}
function pause(){
	myAudio.pause();
	$('.btn-play').removeClass('icon-pause1').addClass('icon-play');
}
//获取频道信息
function jsonpGetChannel(){
	let script = document.createElement('script')
	script.style = "display: none"
	script.src = '//api.jirengu.com/fm/getChannels.php?callback=getChannel'
	document.body.insertBefore(script, document.body.firstChild)
	// document.body.removeChild(img)
	console.log(1)
}
function getChannel(response) {
	console.log(2)
	var channels = response.channels;
			var num = Math.floor(Math.random()*channels.length);
			var channelname = channels[num].name;
			var channelId = channels[num].channel_id;
			$('.record').text(" ：" + channelname);
			$('.record').attr('data-id',channelId);
			getmusic();
}
console.log(3)
// 通过ajax获取歌曲
function getmusic(){
	ajax({
		url: 'https://jirenguapi.applinzi.com/fm/getSong.php',
		type: 'get',
		dataType: 'json',
		data:{
		      "channel": $('.record').attr('data-id')
		    },
		success: function (ret) {
		   var resource = ret.song[0],
		       songUrl = resource.url; 
		       sid = resource.sid,
		       title = resource.title,
		       artist = resource.artist;
		     
		   bgPic = resource.picture; 
	       $('audio').attr('src',songUrl);
	       $('audio').attr('sid',sid);
	       $('.musicname').text(title);
	       $('.musicname').attr('title',title)
	       $('.musicer').text('歌 手：' + artist);
	       $('.musicer').attr('title', artist)
	       $(".background").css({
	       		'background-image':'url('+bgPic+')',
	       		'background-repeat': 'no-repeat',
				'background-position-x': '0px',
				'background-position-y': 'center',
				'background-attchment': 'fixed',
				'background-size': 'cover',
	 		});
	       // console.log( resource)
	       play();//播放
	       getlyric();//获取歌词
	       changeBackground(); //切换歌曲时保持当前界面不变
		}
	})
};
//获取歌词
function getlyric(){
	var Sid = $('audio').attr('sid');
	ajax({
		url: 'https://jirenguapi.applinzi.com/fm/getLyric.php',
		data: {"sid": Sid},
		type: 'post',
		success: function (lyr){
        	// console.log(lyr);
        	// var lyr = JSON.parse(lyr);
        	console.log(lyr);
        	if (!!lyr.lyric) {
	        	$('.music-lyric .lyric').empty();//清空歌词信息
	        	var line = lyr.lyric.split('\n');//歌词为以排数为界的数组
	        	// console.log(line)
                var timeReg = /\[\d{2}:\d{2}.\d{2}\]/g;//时间的正则
                var result = [];
                if(line != ""){
                    for(var i in line){//遍历歌词数组
                        var time = line[i].match(timeReg);//每组匹配时间 得到时间数组
                        // console.log(time)
                        if(!time)continue;//如果没有 就跳过继续
                        var value = line[i].replace(timeReg,"");// 纯歌词
                        for(j in time){//遍历时间数组
                            var t = time[j].slice(1, -1).split(':');//分析时间  时间的格式是[00:00.00] 分钟和毫秒是t[0],t[1]
                            //把结果做成数组 result[0]是当前时间，result[1]是纯歌词
                            var timeArr = parseInt(t[0], 10) * 60 + parseFloat(t[1]); //计算出一个curTime s为单位
                            result.push([timeArr, value]);
                        }
                    }
                }
	            //时间排序
	            result.sort(function (a, b) {
	                return a[0] - b[0];
	            });
	            lyricArr = result;//存到lyricArr里面
	            renderLyric();//渲染歌词
        	}
        },
        error: function(){
        	$('.music-lyric .lyric').html("<li>本歌曲暂时展示没有歌词</li>");
        }
	})
}
function renderLyric(){
	var lyrLi = "";
    for (var i = 0; i < lyricArr.length; i++) {
        lyrLi += "<li data-time='"+lyricArr[i][0]+"'>"+lyricArr[i][1]+"</li>";
    }
    $('.music-lyric .lyric').append(lyrLi);
    // console.log(lyrLi)
    setInterval(showLyric,100);//展示歌词
}
function showLyric(){
    var liH = $(".lyric li").eq(15).outerHeight(); //每行高度
    // console.log(liH)
    for(var i=0;i< lyricArr.length;i++){     //遍历歌词下所有的li
        var curT = $(".lyric li").eq(i).attr("data-time");  //获取当前li存入的当前一排歌词时间
        var nexT = $(".lyric li").eq(i+1).attr("data-time");
        var curTime = myAudio.currentTime;
        if ((curTime > curT) && (curT < nexT)){//当前时间在下一句时间和歌曲当前时间之间的时候 就渲染 并滚动
            $(".lyric li").removeClass("active");
            $(".lyric li").eq(i).addClass("active");
            $('.music-lyric .lyric').css('top', - liH*(i - 3));
            // console.log($('.music-lyric .lyric').css('top');)
        }
    }

}
//进度条控制
setInterval(present,500)	//每0.5秒计算进度条长度
$(".basebar").mousedown(function(ev){  //拖拽进度条控制进度
	var posX = ev.clientX;
	console.log(posX)
	var targetLeft = $(this).offset().left;
	var percentage = (posX - targetLeft)/400*100;
	myAudio.currentTime = myAudio.duration * percentage/100;
});
function present(){
	var length = myAudio.currentTime/myAudio.duration*100;
	$('.progressbar').width(length+'%');//设置进度条长度
	//自动下一曲
	if(myAudio.currentTime == myAudio.duration){
		getmusic()
	}
}
//icon
$('.icon-shoucang').on('click',function(){
	$(this).toggleClass('stared');
})
//上一曲
// $('.icon-last').on('click', function(){
// 	$('audio').attr('src',songUrl)
// })
//单曲循环
$('.icon-danquxunhuan1').on('click',function(){
	$(this).toggleClass('recycleed').toggleClass('colored')
	if ($(this).hasClass('recycleed')) {
		$('audio').attr('loop',true);
		$('.icon-danquxunhuan1').attr('title','取消单曲循环');
	}
	if($(this).hasClass('colored')){
		$('audio').attr('loop', false);
		$('.icon-danquxunhuan1').attr('title','单曲循环');
	}
})

//歌词显示/隐藏
function changeLyric() {
	$('.icon-leyic').toggleClass('lyriced');
	if ($('.icon-leyic').hasClass('lyriced')) {
		$('.background .music-lyric').css({'display':'block'});
		$('.background').css({'background-image': ''});
		$('.controls .icon-leyic').attr('title','隐藏歌词');
	}else{
		$('.background .music-lyric').css({'display':'none'})
		$('.controls .icon-leyic').attr('title','显示歌词');
		$('.background').css({'background-image': 'url('+bgPic+')'})
	}
}
// 切换歌曲时保持界面不变
function changeBackground() {
	if ($('.icon-leyic').hasClass('lyriced')) {
		$('.background .music-lyric').css({'display':'block'});
		$('.background').css({'background-image': ''});
		$('.controls .icon-leyic').attr('title','隐藏歌词');
	}
}

//
function ajax(options){
    options.success = options.success || {}
    options.error = options.error || {}
    options.type = options.type || 'get'
    options.dataType = options.dataType || 'json'
    options.data = options.data || {}
    let dataStr = ''
    for (let key in options.data){
        dataStr += key + '=' + options.data[key] + '&'
    }
    const xhr = new XMLHttpRequest()
    xhr.onreadystatechange = () => {
        if(xhr.readyState === 4){
            if(xhr.status === 200 || xhr.status === 304){
                if (options.dataType === 'text'){
                    options.success(xhr.responseText)
                }
                if(options.dataType === 'json'){
                    let json = JSON.parse(xhr.responseText)
                    options.success(json)
                }
            } else {
                options.error()
            }
        }
    }

    dataStr = dataStr.substr(0, dataStr.length - 1)
    
    if (options.type.toLowerCase() === 'post') {
        xhr.open(options.type, options.url, true)
        xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded')
        xhr.send(dataStr)
    }
    if (options.type.toLowerCase() === 'get') {
        xhr.open(options.type, options.url + '?' + dataStr, true)
        xhr.send()
    }
}

$('.icon-leyic').on('click', changeLyric);
$(document).ready(jsonpGetChannel());